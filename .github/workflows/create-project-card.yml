name: Criar issue e adicionar ao Project v2

on:
  repository_dispatch:
    types: [create_card]

jobs:
  criar_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Criar issue e adicionar ao projeto
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          PROJECT_ID: PVT_kwHOA0czfM4A8xv2
          REPO_OWNER: LuamMaul
          REPO_NAME: bup2
          TICKET_ID: ${{ github.event.client_payload.ticket_id }}
          TICKET_SUBJECT: ${{ github.event.client_payload.ticket_subject }}
        run: |
          set -e

          TITLE="$TICKET_ID - $TICKET_SUBJECT"
          TICKET_LINK="https://esusaps.freshdesk.com/helpdesk/tickets/$TICKET_ID"
          PLANILHA_LINK="https://docs.google.com/spreadsheets/d/1i_ceiljyTheYwYe5XJLmJn2uPJHy4kQVplLpbSDmWEs/edit?gid=1998271206#gid=1998271206"
          DESCRIPTION="[Ticket]($TICKET_LINK)\n\n[Planilha de M√©tricas]($PLANILHA_LINK)"

          echo "üîé Buscando ID do reposit√≥rio..."

          REPO_ID=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { repository(owner: \\\"$REPO_OWNER\\\", name: \\\"$REPO_NAME\\\") { id } }\"}" | jq -r '.data.repository.id')

          echo "üì¶ REPO_ID: $REPO_ID"

          echo "üìù Criando a issue..."

          ISSUE_RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { createIssue(input: {repositoryId: \\\"$REPO_ID\\\", title: \\\"$TITLE\\\", body: \\\"$DESCRIPTION\\\"}) { issue { id number url } } }\"}")

          echo "üì¨ Resposta da cria√ß√£o: $ISSUE_RESPONSE"

          ISSUE_ID=$(echo "$ISSUE_RESPONSE" | jq -r '.data.createIssue.issue.id')

          echo "üìé Adicionando issue ao projeto..."

          ADD_RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { addProjectV2ItemById(input: {projectId: \\\"$PROJECT_ID\\\", contentId: \\\"$ISSUE_ID\\\"}) { item { id } } }\"}")

          ITEM_ID=$(echo "$ADD_RESPONSE" | jq -r '.data.addProjectV2ItemById.item.id')

          echo "üéØ Interpretando prioridade..."

          # MAPA: PRIORITY (1 a 4) ‚Üí ID da op√ß√£o no campo do GitHub Project
          case "$PRIORITY" in
            1) PRIORITY_OPTION_ID="57621d1e" ;;
            2) PRIORITY_OPTION_ID="da944a9c" ;;
            3) PRIORITY_OPTION_ID="0a877460" ;;
            4) PRIORITY_OPTION_ID="79628723" ;;
            *) PRIORITY_OPTION_ID="" ;;
          esac

          if [ -n "$PRIORITY_OPTION_ID" ]; then
            echo "üè∑Ô∏è Aplicando prioridade no card..."

            curl -s -X POST https://api.github.com/graphql \
              -H "Authorization: bearer $GH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"query\": \"mutation {
                updateProjectV2ItemFieldValue(input: {
                  projectId: \\\"$PROJECT_ID\\\",
                  itemId: \\\"$ITEM_ID\\\",
                  fieldId: \\\"PVT_FIELD_PRIORIDADE\\\",
                  value: { singleSelectOptionId: \\\"$PRIORITY_OPTION_ID\\\" }
                }) {
                  projectV2Item { id }
                }
              }\"}"
          else
            echo "‚ö†Ô∏è Prioridade '$PRIORITY' n√£o corresponde a nenhuma op√ß√£o conhecida."
          fi
